# AI Chat Visual Flow Diagram

## Complete Message Flow (Step-by-Step)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           USER INTERACTION                               â”‚
â”‚                                                                          â”‚
â”‚  User types: "Add a bar chart showing sales by category"                â”‚
â”‚  Clicks: Send                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      FRONTEND (ChatSidebar.tsx)                          â”‚
â”‚                                                                          â”‚
â”‚  1. Save user message to MongoDB                                         â”‚
â”‚  2. Build conversation history array:                                    â”‚
â”‚     [                                                                    â”‚
â”‚       {role: "user", content: "Previous msg"},                          â”‚
â”‚       {role: "assistant", content: "Previous reply"},                   â”‚
â”‚       {role: "user", content: "Add a bar chart..."}                     â”‚
â”‚     ]                                                                    â”‚
â”‚  3. Set streaming states:                                                â”‚
â”‚     - isStreaming = true                                                 â”‚
â”‚     - streamingText = ''                                                 â”‚
â”‚     - isEditingCanvas = false                                            â”‚
â”‚                                                                          â”‚
â”‚  4. POST to /api/chat/stream with:                                       â”‚
â”‚     {                                                                    â”‚
â”‚       messages: [...history],                                           â”‚
â”‚       canvasId: "canvas-123",                                           â”‚
â”‚       username: "john"                                                   â”‚
â”‚     }                                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     EXPRESS API (api-server.js)                          â”‚
â”‚                                                                          â”‚
â”‚  1. Fetch current canvas:                                                â”‚
â”‚     const canvas = await getCanvas(canvasId, username)                  â”‚
â”‚     â†’ Returns: {script: "{\"nodes\":[...],\"edges\":[...]}"}            â”‚
â”‚                                                                          â”‚
â”‚  2. Fetch user's data files:                                             â”‚
â”‚     const files = await getUserFiles(username)                          â”‚
â”‚     For each completed file:                                             â”‚
â”‚       const details = await getFileDetails(file.id, username)          â”‚
â”‚     â†’ Returns array of files with schemas and subsets                    â”‚
â”‚                                                                          â”‚
â”‚  3. Proxy to Python API:                                                 â”‚
â”‚     POST http://localhost:8000/api/chat/stream                          â”‚
â”‚     {                                                                    â”‚
â”‚       messages: [...history],                                           â”‚
â”‚       current_canvas: canvas.script,                                    â”‚
â”‚       data_sources: [                                                    â”‚
â”‚         {                                                                â”‚
â”‚           originalFileName: "sales.csv",                                â”‚
â”‚           fileSchema: {                                                  â”‚
â”‚             columns: [{name: "date", type: "date"}, ...],              â”‚
â”‚             rowCount: 1500,                                             â”‚
â”‚             summary: "..."                                              â”‚
â”‚           },                                                             â”‚
â”‚           subsets: [                                                     â”‚
â”‚             {                                                            â”‚
â”‚               description: "Sales by category",                         â”‚
â”‚               xAxisName: "Category",                                    â”‚
â”‚               dataPoints: [{x: "Electronics", y: 45000}, ...]          â”‚
â”‚             }                                                            â”‚
â”‚           ]                                                              â”‚
â”‚         }                                                                â”‚
â”‚       ]                                                                  â”‚
â”‚     }                                                                    â”‚
â”‚                                                                          â”‚
â”‚  4. Stream response back to frontend (pipe)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PYTHON API (main.py)                                  â”‚
â”‚                                                                          â”‚
â”‚  1. Build system prompt:                                                 â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚     â”‚ You are an AI assistant helping build visualizations.       â”‚    â”‚
â”‚     â”‚                                                              â”‚    â”‚
â”‚     â”‚ Current Canvas: 3 nodes, 2 edges                            â”‚    â”‚
â”‚     â”‚ Full JSON: {"nodes":[...], "edges":[...]}                   â”‚    â”‚
â”‚     â”‚                                                              â”‚    â”‚
â”‚     â”‚ Available Data:                                              â”‚    â”‚
â”‚     â”‚ - sales.csv: 5 columns, 1500 rows, 3 visualizations        â”‚    â”‚
â”‚     â”‚                                                              â”‚    â”‚
â”‚     â”‚ Tools Available:                                             â”‚    â”‚
â”‚     â”‚ - edit_canvas: Modify canvas JSON                           â”‚    â”‚
â”‚     â”‚                                                              â”‚    â”‚
â”‚     â”‚ Canvas Format: {"nodes": [...], "edges": [...]}            â”‚    â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                          â”‚
â”‚  2. Start Claude stream:                                                 â”‚
â”‚     async with anthropic_client.messages.stream(                        â”‚
â”‚       model="claude-sonnet-4-20250514",                                 â”‚
â”‚       messages=[...with system prompt],                                 â”‚
â”‚       tools=[edit_canvas tool definition],                              â”‚
â”‚       stream=True                                                        â”‚
â”‚     ) as stream:                                                         â”‚
â”‚                                                                          â”‚
â”‚  3. Process events and emit to frontend:                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â†“
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚    CLAUDE STREAMING      â”‚
                    â”‚                          â”‚
                    â”‚  Generates response...   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        STREAM EVENTS (Line-by-Line)                      â”‚
â”‚                                                                          â”‚
â”‚  Event 1: content_block_delta (text)                                     â”‚
â”‚    â†’ Emit: {"type": "text_delta", "text": "I'll"}                       â”‚
â”‚                                                                          â”‚
â”‚  Event 2: content_block_delta (text)                                     â”‚
â”‚    â†’ Emit: {"type": "text_delta", "text": " create"}                    â”‚
â”‚                                                                          â”‚
â”‚  Event 3: content_block_delta (text)                                     â”‚
â”‚    â†’ Emit: {"type": "text_delta", "text": " a"}                         â”‚
â”‚                                                                          â”‚
â”‚  Event 4: content_block_delta (text)                                     â”‚
â”‚    â†’ Emit: {"type": "text_delta", "text": " bar"}                       â”‚
â”‚                                                                          â”‚
â”‚  Event 5: content_block_delta (text)                                     â”‚
â”‚    â†’ Emit: {"type": "text_delta", "text": " chart"}                     â”‚
â”‚                                                                          â”‚
â”‚  Event 6: content_block_start (tool_use)                                 â”‚
â”‚    â†’ Claude decides: "I need to edit the canvas"                        â”‚
â”‚    â†’ Emit: {"type": "tool_start", "tool_name": "edit_canvas"}           â”‚
â”‚                                                                          â”‚
â”‚  Event 7-15: content_block_delta (partial_json)                          â”‚
â”‚    â†’ Accumulating tool parameters:                                       â”‚
â”‚      '{"canvas_json": "{\"nodes\": [{\"id\": \"chart-1\"...'            â”‚
â”‚                                                                          â”‚
â”‚  Event 16: content_block_stop                                            â”‚
â”‚    â†’ Tool input complete, parse JSON                                     â”‚
â”‚    â†’ Validate canvas_json is valid                                       â”‚
â”‚    â†’ Emit: {                                                             â”‚
â”‚         "type": "canvas_update",                                         â”‚
â”‚         "canvas": "{\"nodes\":[{\"id\":\"chart-1\",\"type\":\"chart\",  â”‚
â”‚                      \"position\":{\"x\":100,\"y\":100},                â”‚
â”‚                      \"data\":{\"chartType\":\"bar\",                   â”‚
â”‚                                \"dataSource\":\"file-abc123\",          â”‚
â”‚                                \"subset\":\"sales-by-category\"}}],     â”‚
â”‚                   \"edges\":[]}",                                        â”‚
â”‚         "explanation": "Added bar chart with sales data"                â”‚
â”‚       }                                                                  â”‚
â”‚    â†’ Emit: {"type": "tool_finish", "tool_name": "edit_canvas"}          â”‚
â”‚                                                                          â”‚
â”‚  Event 17: content_block_delta (text)                                    â”‚
â”‚    â†’ Emit: {"type": "text_delta", "text": " I've"}                      â”‚
â”‚                                                                          â”‚
â”‚  Event 18-25: content_block_delta (text)                                 â”‚
â”‚    â†’ Emit more text deltas: " added", " the", " chart", " to", ...      â”‚
â”‚                                                                          â”‚
â”‚  Event 26: message_stop                                                  â”‚
â”‚    â†’ Emit: {                                                             â”‚
â”‚         "type": "done",                                                  â”‚
â”‚         "usage": {                                                       â”‚
â”‚           "input_tokens": 1523,                                         â”‚
â”‚           "output_tokens": 847                                          â”‚
â”‚         }                                                                â”‚
â”‚       }                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â”‚ All events streamed back through Express
                                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     FRONTEND RECEIVES EVENTS                             â”‚
â”‚                                                                          â”‚
â”‚  Reading stream line-by-line:                                            â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ const reader = response.body.getReader();                       â”‚    â”‚
â”‚  â”‚ while (true) {                                                  â”‚    â”‚
â”‚  â”‚   const {done, value} = await reader.read();                   â”‚    â”‚
â”‚  â”‚   // Decode and parse JSON lines                               â”‚    â”‚
â”‚  â”‚   const event = JSON.parse(line);                              â”‚    â”‚
â”‚  â”‚   handleEvent(event);                                           â”‚    â”‚
â”‚  â”‚ }                                                                â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                          â”‚
â”‚  Process Each Event:                                                     â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€ text_delta â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ assistantText += event.text;                                   â”‚    â”‚
â”‚  â”‚ setStreamingText(assistantText);                               â”‚    â”‚
â”‚  â”‚ â†’ UI: "I'll" â†’ "I'll create" â†’ "I'll create a" ...           â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€ tool_start â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ setIsEditingCanvas(true);                                      â”‚    â”‚
â”‚  â”‚ â†’ UI: Show spinner "ğŸ”§ Editing canvas..."                      â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€ canvas_update â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ // Update canvas in database                                   â”‚    â”‚
â”‚  â”‚ await fetch('/api/canvas/.../script', {                        â”‚    â”‚
â”‚  â”‚   method: 'PATCH',                                              â”‚    â”‚
â”‚  â”‚   body: JSON.stringify({script: event.canvas})                 â”‚    â”‚
â”‚  â”‚ });                                                             â”‚    â”‚
â”‚  â”‚                                                                 â”‚    â”‚
â”‚  â”‚ // Reload canvas to show changes                               â”‚    â”‚
â”‚  â”‚ await onReloadCanvas();                                         â”‚    â”‚
â”‚  â”‚                                                                 â”‚    â”‚
â”‚  â”‚ toast.success('Canvas updated!');                              â”‚    â”‚
â”‚  â”‚ â†’ UI: Canvas redraws with new chart node                       â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€ tool_finish â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ setIsEditingCanvas(false);                                     â”‚    â”‚
â”‚  â”‚ â†’ UI: Hide spinner                                              â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€ done â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ setIsStreaming(false);                                         â”‚    â”‚
â”‚  â”‚                                                                 â”‚    â”‚
â”‚  â”‚ // Save complete message to database                           â”‚    â”‚
â”‚  â”‚ await fetch('/api/canvas/.../chat/.../message', {              â”‚    â”‚
â”‚  â”‚   method: 'POST',                                               â”‚    â”‚
â”‚  â”‚   body: JSON.stringify({                                        â”‚    â”‚
â”‚  â”‚     role: 'assistant',                                          â”‚    â”‚
â”‚  â”‚     content: assistantText                                      â”‚    â”‚
â”‚  â”‚   })                                                            â”‚    â”‚
â”‚  â”‚ });                                                             â”‚    â”‚
â”‚  â”‚                                                                 â”‚    â”‚
â”‚  â”‚ // Update local chat state                                      â”‚    â”‚
â”‚  â”‚ setChats(...add new message...);                               â”‚    â”‚
â”‚  â”‚                                                                 â”‚    â”‚
â”‚  â”‚ setStreamingText('');                                          â”‚    â”‚
â”‚  â”‚ â†’ UI: Message moves to chat history, input re-enabled         â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           FINAL UI STATE                                 â”‚
â”‚                                                                          â”‚
â”‚  Chat Messages:                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ ğŸ‘¤ User: "Add a bar chart showing sales by category"           â”‚    â”‚
â”‚  â”‚                                                                 â”‚    â”‚
â”‚  â”‚ ğŸ¤– Assistant: "I'll create a bar chart for you. I've added    â”‚    â”‚
â”‚  â”‚    the chart to your canvas!"                                  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                          â”‚
â”‚  Canvas:                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—                                    â”‚    â”‚
â”‚  â”‚  â•‘ Bar Chart             â•‘                                     â”‚    â”‚
â”‚  â”‚  â•‘ Sales by Category     â•‘                                     â”‚    â”‚
â”‚  â”‚  â•‘ â–ˆâ–ˆâ–ˆâ–ˆ Electronics      â•‘                                     â”‚    â”‚
â”‚  â”‚  â•‘ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ Groceries      â•‘                                     â”‚    â”‚
â”‚  â”‚  â•‘ â–ˆâ–ˆâ–ˆ Clothing          â•‘                                     â”‚    â”‚
â”‚  â”‚  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                                    â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                          â”‚
â”‚  [Type a message...] [Send]  â† Re-enabled for next message              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Timing Diagram

```
Time  â”‚ Frontend         â”‚ Express          â”‚ Python           â”‚ Claude
â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
0ms   â”‚ Send clicked     â”‚                  â”‚                  â”‚
      â”‚ Disable input    â”‚                  â”‚                  â”‚
      â”‚                  â”‚                  â”‚                  â”‚
50ms  â”‚ POST request â†’   â”‚                  â”‚                  â”‚
      â”‚                  â”‚                  â”‚                  â”‚
100ms â”‚                  â”‚ Get canvas âœ“     â”‚                  â”‚
      â”‚                  â”‚ Get files âœ“      â”‚                  â”‚
      â”‚                  â”‚ POST to Python â†’ â”‚                  â”‚
      â”‚                  â”‚                  â”‚                  â”‚
150ms â”‚                  â”‚                  â”‚ Build prompt âœ“   â”‚
      â”‚                  â”‚                  â”‚ Start stream â†’   â”‚
      â”‚                  â”‚                  â”‚                  â”‚
200ms â”‚                  â”‚                  â”‚                  â”‚ Thinking...
      â”‚                  â”‚                  â”‚                  â”‚
500ms â”‚                  â”‚                  â”‚ â† text_delta     â”‚ "I'll"
      â”‚ â† "I'll"         â”‚                  â”‚                  â”‚
      â”‚ Display âœ“        â”‚                  â”‚                  â”‚
      â”‚                  â”‚                  â”‚                  â”‚
520ms â”‚ â† "create"       â”‚                  â”‚ â† text_delta     â”‚ "create"
      â”‚ Display âœ“        â”‚                  â”‚                  â”‚
      â”‚                  â”‚                  â”‚                  â”‚
540ms â”‚ â† "a"            â”‚                  â”‚ â† text_delta     â”‚ "a"
      â”‚ Display âœ“        â”‚                  â”‚                  â”‚
      â”‚                  â”‚                  â”‚                  â”‚
...   â”‚ (streaming...)   â”‚                  â”‚                  â”‚
      â”‚                  â”‚                  â”‚                  â”‚
2000msâ”‚                  â”‚                  â”‚ â† tool_start     â”‚ (tool use)
      â”‚ â† tool_start     â”‚                  â”‚                  â”‚
      â”‚ Show spinner âœ“   â”‚                  â”‚                  â”‚
      â”‚                  â”‚                  â”‚                  â”‚
2100msâ”‚                  â”‚                  â”‚                  â”‚ Generating
      â”‚                  â”‚                  â”‚                  â”‚ JSON...
      â”‚                  â”‚                  â”‚                  â”‚
3000msâ”‚                  â”‚                  â”‚ â† canvas_update  â”‚ (JSON done)
      â”‚ â† canvas_update  â”‚                  â”‚                  â”‚
      â”‚ Update DB âœ“      â”‚                  â”‚                  â”‚
      â”‚ Reload canvas âœ“  â”‚                  â”‚                  â”‚
      â”‚ Toast âœ“          â”‚                  â”‚                  â”‚
      â”‚                  â”‚                  â”‚                  â”‚
3050msâ”‚ â† tool_finish    â”‚                  â”‚ â† tool_finish    â”‚
      â”‚ Hide spinner âœ“   â”‚                  â”‚                  â”‚
      â”‚                  â”‚                  â”‚                  â”‚
3100msâ”‚ â† "I've"         â”‚                  â”‚ â† text_delta     â”‚ "I've"
      â”‚ Display âœ“        â”‚                  â”‚                  â”‚
      â”‚                  â”‚                  â”‚                  â”‚
...   â”‚ (more text...)   â”‚                  â”‚                  â”‚
      â”‚                  â”‚                  â”‚                  â”‚
4000msâ”‚ â† done           â”‚                  â”‚ â† message_stop   â”‚ (complete)
      â”‚ Save msg âœ“       â”‚                  â”‚                  â”‚
      â”‚ Enable input âœ“   â”‚                  â”‚                  â”‚
â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Total: ~4 seconds from send to complete
```

## State Transitions

```
Frontend State Machine:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   IDLE      â”‚ â† Initial state, waiting for user input
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ User sends message
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STREAMING   â”‚ â† Receiving text deltas from AI
â”‚ TEXT        â”‚   - streamingText updates word-by-word
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜   - Input disabled
       â”‚ AI calls edit_canvas tool
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ EDITING     â”‚ â† AI is modifying canvas
â”‚ CANVAS      â”‚   - Spinner visible "Editing canvas..."
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜   - Still streaming text in background
       â”‚ Canvas update complete
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STREAMING   â”‚ â† Back to streaming text
â”‚ TEXT        â”‚   - Spinner hidden
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜   - AI may continue talking
       â”‚ Stream completes
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SAVING      â”‚ â† Brief state while saving to DB
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ Save complete
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   IDLE      â”‚ â† Ready for next message
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   - Input enabled
                  - Message in chat history
```

## Error States

```
Error Can Occur At Any Point:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ERROR HANDLING                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  1. Frontend Network Error                                   â”‚
â”‚     â†’ catch(error)                                           â”‚
â”‚     â†’ toast.error("Failed to get AI response")              â”‚
â”‚     â†’ Reset states (isStreaming = false)                     â”‚
â”‚     â†’ Enable input                                           â”‚
â”‚                                                              â”‚
â”‚  2. Python API Error                                         â”‚
â”‚     â†’ Emit: {"type": "error", "error": "..."}               â”‚
â”‚     â†’ Frontend shows: toast.error("AI Error: ...")          â”‚
â”‚     â†’ Stop stream, reset states                              â”‚
â”‚                                                              â”‚
â”‚  3. Invalid Canvas JSON                                      â”‚
â”‚     â†’ Python catches JSON parse error                        â”‚
â”‚     â†’ Emit: {"type": "error", "error": "Invalid JSON"}      â”‚
â”‚     â†’ Frontend shows error                                   â”‚
â”‚     â†’ No canvas update occurs                                â”‚
â”‚                                                              â”‚
â”‚  4. MongoDB Save Fails                                       â”‚
â”‚     â†’ Frontend catch block                                   â”‚
â”‚     â†’ Shows error but keeps streaming message in UI          â”‚
â”‚     â†’ User can see response even if save failed              â”‚
â”‚                                                              â”‚
â”‚  5. User Navigates Away                                      â”‚
â”‚     â†’ AbortController cancels request                        â”‚
â”‚     â†’ Silent cleanup                                         â”‚
â”‚     â†’ Server continues processing (stateless)                â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Data Flow Summary

```
USER INPUT
    â†“
CONVERSATION HISTORY (MongoDB)
    â†“
CANVAS STATE (MongoDB)
    â†“
DATA FILES (MongoDB + GridFS)
    â†“
SYSTEM PROMPT (Python)
    â†“
CLAUDE AI (Anthropic API)
    â†“
STREAMING EVENTS (SSE)
    â†“
CANVAS UPDATE (MongoDB)
    â†“
UI REFRESH (React)
    â†“
USER SEES RESULT
```

This architecture ensures:
- Real-time user feedback (streaming)
- Data persistence (MongoDB)
- Scalability (stateless backend)
- Error resilience (try/catch everywhere)
- User autonomy (can navigate away anytime)
